
<!DOCTYPE html>
<html lang="zh-CN">


<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#202020"/>
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>
  
  
    <meta name="keywords" content="kata-containers,containerd," />
  

  
    <meta name="description" content="containerd with kata-container" />
  
  
  <link rel="icon" type="image/x-icon" href="/images/logo.jpg">
  <title>containerd with kata-container [ Yushanjin&#39;s Blog ]</title>
  
    <!-- stylesheets list from config.yml -->
    
      <link rel="stylesheet" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css">
    
      <link rel="stylesheet" href="/css/xoxo.css">
    
  
<meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="Yushanjin's Blog" type="application/atom+xml">
</head>


<body>
  <div class="nav-container">
    <nav class="home-menu pure-menu pure-menu-horizontal">
  <a class="pure-menu-heading" href="/">
    <img class="avatar" src="https://yushanjin.github.io/images/logo.jpg">
    <span class="title">Yushanjin&#39;s Blog</span>
  </a>

  <ul class="pure-menu-list clearfix">
      
          
            <li class="pure-menu-item"><a href="/" class="pure-menu-link">首页</a></li>
          
      
          
            <li class="pure-menu-item"><a href="/archives" class="pure-menu-link">归档</a></li>
          
      
          
            <li class="pure-menu-item"><a href="/tags" class="pure-menu-link">标签</a></li>
          
      
          
            <li class="pure-menu-item"><a href="/categories" class="pure-menu-link">分类</a></li>
          
      
          
            <li class="pure-menu-item"><a href="/search" class="pure-menu-link">搜索</a></li>
          
      
          
            <li class="pure-menu-item"><a href="/about" class="pure-menu-link">关于</a></li>
          
      
          
            <li class="pure-menu-item"><a href="/atom.xml" class="pure-menu-link">订阅</a></li>
          
      
  </ul>
   
</nav>

  </div>

  <div class="container" id="content-outer">
    <div class="inner" id="content-inner">
      <div class="post-container">
  <article class="post" id="post">
    <header class="post-header text-center">
      <h1 class="title">
        containerd with kata-container
      </h1>
      <span>
        
        <time class="time" datetime="2021-02-07T06:03:02.000Z">
        2021-02-07
      </time>
        
      </span>
      <span class="slash">/</span>
      <span class="post-meta">
      <span class="post-tags">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/containerd/" rel="tag">containerd</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kata-containers/" rel="tag">kata-containers</a></li></ul>
      </span>
    </span>
      <span class="slash">/</span>
      <span class="read">
      <span id="busuanzi_value_page_pv"></span> 点击
    </span>
      <span class="slash">/</span>
      <span class="read">阅读耗时 12 分钟</span>
    </header>

    <div class="post-content">
      <p>参考：<a target="_blank" rel="noopener" href="https://github.com/kata-containers/documentation/blob/master/how-to/containerd-kata.md">https://github.com/kata-containers/documentation/blob/master/how-to/containerd-kata.md</a></p>
<h1 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h1><p>已安装kata container及containerd</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-001:~# kata-runtime --version</span><br><span class="line">kata-runtime  : 1.13.0-alpha0</span><br><span class="line">   commit   : &lt;&lt;unknown&gt;&gt;</span><br><span class="line">   OCI specs: 1.0.1-dev</span><br><span class="line"></span><br><span class="line">root@ubuntu-001:~# containerd --version</span><br><span class="line">containerd containerd.io 1.4.3 269548fa27e0089a8b8278fc4fc781d7f65a939b</span><br><span class="line"></span><br><span class="line">root@ubuntu-001:~# ctr --version</span><br><span class="line">ctr containerd.io 1.4.3</span><br></pre></td></tr></table></figure>
<p>注意：</p>
<p>containerd在安装docker（新版本docker）已经作为docker依赖项安装了</p>
<p>ctr是containerd的命令行工具（containerd CLI）</p>
<p>cri is a native plugin of containerd 1.1 and above. It is built into containerd and enabled by default. You do not need to install cri if you have containerd 1.1 or above. Just remove the cri plugin from the list of disabled_plugins in the containerd configuration file (/etc/containerd/config.toml).</p>
<h1 id="配置containerd配置文件"><a href="#配置containerd配置文件" class="headerlink" title="配置containerd配置文件"></a>配置containerd配置文件</h1><p>1、获取containerd默认配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-001:~# containerd config default &gt; &#x2F;etc&#x2F;containerd&#x2F;config.toml</span><br></pre></td></tr></table></figure>

<p>2、修改/etc/containerd/config.toml，增加kata配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-001:~# cat &#x2F;etc&#x2F;containerd&#x2F;config.toml </span><br><span class="line">version &#x3D; 2</span><br><span class="line">root &#x3D; &quot;&#x2F;var&#x2F;lib&#x2F;containerd&quot;</span><br><span class="line">state &#x3D; &quot;&#x2F;run&#x2F;containerd&quot;</span><br><span class="line">plugin_dir &#x3D; &quot;&quot;</span><br><span class="line">disabled_plugins &#x3D; []</span><br><span class="line">required_plugins &#x3D; []</span><br><span class="line">oom_score &#x3D; 0</span><br><span class="line"></span><br><span class="line">[grpc]</span><br><span class="line">  address &#x3D; &quot;&#x2F;run&#x2F;containerd&#x2F;containerd.sock&quot;</span><br><span class="line">  tcp_address &#x3D; &quot;&quot;</span><br><span class="line">  tcp_tls_cert &#x3D; &quot;&quot;</span><br><span class="line">  tcp_tls_key &#x3D; &quot;&quot;</span><br><span class="line">  uid &#x3D; 0</span><br><span class="line">  gid &#x3D; 0</span><br><span class="line">  max_recv_message_size &#x3D; 16777216</span><br><span class="line">  max_send_message_size &#x3D; 16777216</span><br><span class="line"></span><br><span class="line">[ttrpc]</span><br><span class="line">  address &#x3D; &quot;&quot;</span><br><span class="line">  uid &#x3D; 0</span><br><span class="line">  gid &#x3D; 0</span><br><span class="line"></span><br><span class="line">[debug]</span><br><span class="line">  address &#x3D; &quot;&quot;</span><br><span class="line">  uid &#x3D; 0</span><br><span class="line">  gid &#x3D; 0</span><br><span class="line">  level &#x3D; &quot;&quot;</span><br><span class="line"></span><br><span class="line">[metrics]</span><br><span class="line">  address &#x3D; &quot;&quot;</span><br><span class="line">  grpc_histogram &#x3D; false</span><br><span class="line"></span><br><span class="line">[cgroup]</span><br><span class="line">  path &#x3D; &quot;&quot;</span><br><span class="line"></span><br><span class="line">[timeouts]</span><br><span class="line">  &quot;io.containerd.timeout.shim.cleanup&quot; &#x3D; &quot;5s&quot;</span><br><span class="line">  &quot;io.containerd.timeout.shim.load&quot; &#x3D; &quot;5s&quot;</span><br><span class="line">  &quot;io.containerd.timeout.shim.shutdown&quot; &#x3D; &quot;3s&quot;</span><br><span class="line">  &quot;io.containerd.timeout.task.state&quot; &#x3D; &quot;2s&quot;</span><br><span class="line"></span><br><span class="line">[plugins]</span><br><span class="line">  [plugins.&quot;io.containerd.gc.v1.scheduler&quot;]</span><br><span class="line">    pause_threshold &#x3D; 0.02</span><br><span class="line">    deletion_threshold &#x3D; 0</span><br><span class="line">    mutation_threshold &#x3D; 100</span><br><span class="line">    schedule_delay &#x3D; &quot;0s&quot;</span><br><span class="line">    startup_delay &#x3D; &quot;100ms&quot;</span><br><span class="line">  [plugins.&quot;io.containerd.grpc.v1.cri&quot;]</span><br><span class="line">    disable_tcp_service &#x3D; true</span><br><span class="line">    stream_server_address &#x3D; &quot;127.0.0.1&quot;</span><br><span class="line">    stream_server_port &#x3D; &quot;0&quot;</span><br><span class="line">    stream_idle_timeout &#x3D; &quot;4h0m0s&quot;</span><br><span class="line">    enable_selinux &#x3D; false</span><br><span class="line">    selinux_category_range &#x3D; 1024</span><br><span class="line">    sandbox_image &#x3D; &quot;registry.aliyuncs.com&#x2F;google_containers&#x2F;pause:3.2&quot;</span><br><span class="line">    stats_collect_period &#x3D; 10</span><br><span class="line">    systemd_cgroup &#x3D; false</span><br><span class="line">    enable_tls_streaming &#x3D; false</span><br><span class="line">    max_container_log_line_size &#x3D; 16384</span><br><span class="line">    disable_cgroup &#x3D; false</span><br><span class="line">    disable_apparmor &#x3D; false</span><br><span class="line">    restrict_oom_score_adj &#x3D; false</span><br><span class="line">    max_concurrent_downloads &#x3D; 3</span><br><span class="line">    disable_proc_mount &#x3D; false</span><br><span class="line">    unset_seccomp_profile &#x3D; &quot;&quot;</span><br><span class="line">    tolerate_missing_hugetlb_controller &#x3D; true</span><br><span class="line">    disable_hugetlb_controller &#x3D; true</span><br><span class="line">    ignore_image_defined_volumes &#x3D; false</span><br><span class="line">    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd]</span><br><span class="line">      snapshotter &#x3D; &quot;overlayfs&quot;</span><br><span class="line">      default_runtime_name &#x3D; &quot;runc&quot;</span><br><span class="line">      no_pivot &#x3D; false</span><br><span class="line">      disable_snapshot_annotations &#x3D; true</span><br><span class="line">      discard_unpacked_layers &#x3D; false</span><br><span class="line">      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.default_runtime]</span><br><span class="line">        runtime_type &#x3D; &quot;&quot;</span><br><span class="line">        runtime_engine &#x3D; &quot;&quot;</span><br><span class="line">        runtime_root &#x3D; &quot;&quot;</span><br><span class="line">        privileged_without_host_devices &#x3D; false</span><br><span class="line">        base_runtime_spec &#x3D; &quot;&quot;</span><br><span class="line">      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.untrusted_workload_runtime]</span><br><span class="line">        runtime_type &#x3D; &quot;&quot;</span><br><span class="line">        runtime_engine &#x3D; &quot;&quot;</span><br><span class="line">        runtime_root &#x3D; &quot;&quot;</span><br><span class="line">        privileged_without_host_devices &#x3D; false</span><br><span class="line">        base_runtime_spec &#x3D; &quot;&quot;</span><br><span class="line">      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes]</span><br><span class="line">        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc]</span><br><span class="line">          runtime_type &#x3D; &quot;io.containerd.runc.v2&quot;</span><br><span class="line">          runtime_engine &#x3D; &quot;&quot;</span><br><span class="line">          runtime_root &#x3D; &quot;&quot;</span><br><span class="line">          privileged_without_host_devices &#x3D; false</span><br><span class="line">          base_runtime_spec &#x3D; &quot;&quot;</span><br><span class="line">          [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc.options]</span><br><span class="line">        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.kata]</span><br><span class="line">          runtime_type &#x3D; &quot;io.containerd.kata.v2&quot;</span><br><span class="line">          runtime_engine &#x3D; &quot;&quot;</span><br><span class="line">          runtime_root &#x3D; &quot;&quot;</span><br><span class="line">          privileged_without_host_devices &#x3D; false</span><br><span class="line">          base_runtime_spec &#x3D; &quot;&quot;</span><br><span class="line">          [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.kata.options]</span><br><span class="line">    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.cni]</span><br><span class="line">      bin_dir &#x3D; &quot;&#x2F;opt&#x2F;cni&#x2F;bin&quot;</span><br><span class="line">      conf_dir &#x3D; &quot;&#x2F;etc&#x2F;cni&#x2F;net.d&quot;</span><br><span class="line">      max_conf_num &#x3D; 1</span><br><span class="line">      conf_template &#x3D; &quot;&quot;</span><br><span class="line">    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry]</span><br><span class="line">      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors]</span><br><span class="line">        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;docker.io&quot;]</span><br><span class="line">          endpoint &#x3D; [&quot;https:&#x2F;&#x2F;registry-1.docker.io&quot;]</span><br><span class="line">    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.image_decryption]</span><br><span class="line">      key_model &#x3D; &quot;&quot;</span><br><span class="line">    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.x509_key_pair_streaming]</span><br><span class="line">      tls_cert_file &#x3D; &quot;&quot;</span><br><span class="line">      tls_key_file &#x3D; &quot;&quot;</span><br><span class="line">  [plugins.&quot;io.containerd.internal.v1.opt&quot;]</span><br><span class="line">    path &#x3D; &quot;&#x2F;opt&#x2F;containerd&quot;</span><br><span class="line">  [plugins.&quot;io.containerd.internal.v1.restart&quot;]</span><br><span class="line">    interval &#x3D; &quot;10s&quot;</span><br><span class="line">  [plugins.&quot;io.containerd.metadata.v1.bolt&quot;]</span><br><span class="line">    content_sharing_policy &#x3D; &quot;shared&quot;</span><br><span class="line">  [plugins.&quot;io.containerd.monitor.v1.cgroups&quot;]</span><br><span class="line">    no_prometheus &#x3D; false</span><br><span class="line">  [plugins.&quot;io.containerd.runtime.v1.linux&quot;]</span><br><span class="line">    shim &#x3D; &quot;containerd-shim&quot;</span><br><span class="line">    runtime &#x3D; &quot;runc&quot;</span><br><span class="line">    runtime_root &#x3D; &quot;&quot;</span><br><span class="line">    no_shim &#x3D; false</span><br><span class="line">    shim_debug &#x3D; false</span><br><span class="line">  [plugins.&quot;io.containerd.runtime.v2.task&quot;]</span><br><span class="line">    platforms &#x3D; [&quot;linux&#x2F;amd64&quot;]</span><br><span class="line">  [plugins.&quot;io.containerd.service.v1.diff-service&quot;]</span><br><span class="line">    default &#x3D; [&quot;walking&quot;]</span><br><span class="line">  [plugins.&quot;io.containerd.snapshotter.v1.devmapper&quot;]</span><br><span class="line">    root_path &#x3D; &quot;&quot;</span><br><span class="line">    pool_name &#x3D; &quot;&quot;</span><br><span class="line">    base_image_size &#x3D; &quot;&quot;</span><br><span class="line">    async_remove &#x3D; false</span><br></pre></td></tr></table></figure>

<p>对于配置文件的说明，详细见：<a target="_blank" rel="noopener" href="https://github.com/containerd/cri/blob/master/docs/config.md(https://github.com/containerd/cri/blob/master/docs/config.md)">https://github.com/containerd/cri/blob/master/docs/config.md(https://github.com/containerd/cri/blob/master/docs/config.md)</a></p>
<h1 id="重启containerd服务"><a href="#重启containerd服务" class="headerlink" title="重启containerd服务"></a>重启containerd服务</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-001:~# systemctl restart containerd.service </span><br><span class="line">root@ubuntu-001:~# systemctl status containerd.service </span><br><span class="line">● containerd.service - containerd container runtime</span><br><span class="line">   Loaded: loaded (&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;containerd.service; enabled; vendor preset: enabled)</span><br><span class="line">   Active: active (running) since Sun 2021-02-07 14:47:19 CST; 7s ago</span><br><span class="line">     Docs: https:&#x2F;&#x2F;containerd.io</span><br><span class="line">  Process: 49492 ExecStartPre&#x3D;&#x2F;sbin&#x2F;modprobe overlay (code&#x3D;exited, status&#x3D;0&#x2F;SUCCESS)</span><br><span class="line"> Main PID: 49495 (containerd)</span><br><span class="line">    Tasks: 12</span><br><span class="line">   CGroup: &#x2F;system.slice&#x2F;containerd.service</span><br><span class="line">           └─49495 &#x2F;usr&#x2F;bin&#x2F;containerd</span><br><span class="line"></span><br><span class="line">Feb 07 14:47:19 ubuntu-001 containerd[49495]: time&#x3D;&quot;2021-02-07T14:47:19.601885424+08:00&quot; level&#x3D;info msg&#x3D;serving... address&#x3D;&#x2F;run&#x2F;containerd&#x2F;containerd.sock.ttrpc</span><br><span class="line">Feb 07 14:47:19 ubuntu-001 containerd[49495]: time&#x3D;&quot;2021-02-07T14:47:19.602030656+08:00&quot; level&#x3D;info msg&#x3D;serving... address&#x3D;&#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">Feb 07 14:47:19 ubuntu-001 systemd[1]: Started containerd container runtime.</span><br><span class="line">Feb 07 14:47:19 ubuntu-001 containerd[49495]: time&#x3D;&quot;2021-02-07T14:47:19.603347612+08:00&quot; level&#x3D;info msg&#x3D;&quot;containerd successfully booted in 0.038926s&quot;</span><br><span class="line">Feb 07 14:47:19 ubuntu-001 containerd[49495]: time&#x3D;&quot;2021-02-07T14:47:19.620111786+08:00&quot; level&#x3D;info msg&#x3D;&quot;Start subscribing containerd event&quot;</span><br><span class="line">Feb 07 14:47:19 ubuntu-001 containerd[49495]: time&#x3D;&quot;2021-02-07T14:47:19.620341044+08:00&quot; level&#x3D;info msg&#x3D;&quot;Start recovering state&quot;</span><br><span class="line">Feb 07 14:47:19 ubuntu-001 containerd[49495]: time&#x3D;&quot;2021-02-07T14:47:19.647143755+08:00&quot; level&#x3D;info msg&#x3D;&quot;Start event monitor&quot;</span><br><span class="line">Feb 07 14:47:19 ubuntu-001 containerd[49495]: time&#x3D;&quot;2021-02-07T14:47:19.647352452+08:00&quot; level&#x3D;info msg&#x3D;&quot;Start snapshots syncer&quot;</span><br><span class="line">Feb 07 14:47:19 ubuntu-001 containerd[49495]: time&#x3D;&quot;2021-02-07T14:47:19.647463902+08:00&quot; level&#x3D;info msg&#x3D;&quot;Start cni network conf syncer&quot;</span><br><span class="line">Feb 07 14:47:19 ubuntu-001 containerd[49495]: time&#x3D;&quot;2021-02-07T14:47:19.647544196+08:00&quot; level&#x3D;info msg&#x3D;&quot;Start streaming server&quot;</span><br></pre></td></tr></table></figure>

<h1 id="配置cri的命令行（crictl）配置"><a href="#配置cri的命令行（crictl）配置" class="headerlink" title="配置cri的命令行（crictl）配置"></a>配置cri的命令行（crictl）配置</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-001:~# cat &#x2F;etc&#x2F;crictl.yaml </span><br><span class="line">runtime-endpoint: unix:&#x2F;&#x2F;&#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">image-endpoint: unix:&#x2F;&#x2F;&#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">timeout: 10</span><br><span class="line">debug: false</span><br><span class="line"></span><br><span class="line">root@ubuntu-001:~# crictl version</span><br><span class="line">Version:  0.1.0</span><br><span class="line">RuntimeName:  containerd</span><br><span class="line">RuntimeVersion:  1.4.3</span><br><span class="line">RuntimeApiVersion:  v1alpha2</span><br></pre></td></tr></table></figure>
<h1 id="使用containerd运行容器"><a href="#使用containerd运行容器" class="headerlink" title="使用containerd运行容器"></a>使用containerd运行容器</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">pull镜像</span><br><span class="line">root@ubuntu-001:~# ctr image pull docker.io&#x2F;library&#x2F;busybox:latest</span><br><span class="line">docker.io&#x2F;library&#x2F;busybox:latest:                                                 resolved       |++++++++++++++++++++++++++++++++++++++| </span><br><span class="line">index-sha256:e1488cb900233d035575f0a7787448cb1fa93bed0ccc0d4efc1963d7d72a8f17:    done           |++++++++++++++++++++++++++++++++++++++| </span><br><span class="line">manifest-sha256:56853b711255f4a0bc7c44d2158167f03f64ef75a22a0249a9fae4703ec10f61: done           |++++++++++++++++++++++++++++++++++++++| </span><br><span class="line">layer-sha256:4c892f00285e3ea7b8a08a03d04df2bc021a11fe838aa23d8e4ed17081ea3c18:    done           |++++++++++++++++++++++++++++++++++++++| </span><br><span class="line">config-sha256:22667f53682a2920948d19c7133ab1c9c3f745805c14125859d20cede07f11f9:   done           |++++++++++++++++++++++++++++++++++++++| </span><br><span class="line">elapsed: 12.7s                                                                    total:  4.0 Ki (319.0 B&#x2F;s)                                       </span><br><span class="line">unpacking linux&#x2F;amd64 sha256:e1488cb900233d035575f0a7787448cb1fa93bed0ccc0d4efc1963d7d72a8f17...</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">查询镜像</span><br><span class="line">root@ubuntu-001:~# ctr images ls</span><br><span class="line">REF                              TYPE                                                      DIGEST                                                                  SIZE      PLATFORMS                                                                                                            LABELS </span><br><span class="line">docker.io&#x2F;library&#x2F;busybox:latest application&#x2F;vnd.docker.distribution.manifest.list.v2+json sha256:e1488cb900233d035575f0a7787448cb1fa93bed0ccc0d4efc1963d7d72a8f17 750.7 KiB linux&#x2F;386,linux&#x2F;amd64,linux&#x2F;arm&#x2F;v5,linux&#x2F;arm&#x2F;v6,linux&#x2F;arm&#x2F;v7,linux&#x2F;arm64&#x2F;v8,linux&#x2F;mips64le,linux&#x2F;ppc64le,linux&#x2F;s390x -</span><br><span class="line"></span><br><span class="line">运行容器</span><br><span class="line"></span><br><span class="line">root@ubuntu-001:~# ctr run --runtime io.containerd.run.kata.v2 -t -d --rm docker.io&#x2F;library&#x2F;busybox:latest hello-kata</span><br><span class="line">root@ubuntu-001:~# ctr run -t -d --rm docker.io&#x2F;library&#x2F;busybox:latest hello-runc</span><br><span class="line">&#x2F; # root@ubuntu-001:~# </span><br><span class="line">root@ubuntu-001:~# ps -ef|grep containerd</span><br><span class="line">root      42028   1725  0 14:13 ?        00:00:01 containerd</span><br><span class="line">root      49495      1  0 14:47 ?        00:00:04 &#x2F;usr&#x2F;bin&#x2F;containerd</span><br><span class="line">root      49524      1  0 14:47 ?        00:00:00 &#x2F;usr&#x2F;bin&#x2F;dockerd -H fd:&#x2F;&#x2F; --containerd&#x3D;&#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">root      63129      1  0 15:43 ?        00:00:00 &#x2F;usr&#x2F;bin&#x2F;containerd-shim-kata-v2 -namespace default -address &#x2F;run&#x2F;containerd&#x2F;containerd.sock -publish-binary &#x2F;usr&#x2F;bin&#x2F;containerd -id hello-kata</span><br><span class="line">root      63219      1  0 15:43 ?        00:00:00 &#x2F;usr&#x2F;bin&#x2F;containerd-shim-runc-v2 -namespace default -id hello-runc -address &#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">root      63382  58536  0 15:43 pts&#x2F;2    00:00:00 grep --color&#x3D;auto containerd</span><br><span class="line"></span><br><span class="line">root@ubuntu-001:~# ctr tasks list</span><br><span class="line">TASK          PID      STATUS    </span><br><span class="line">hello-kata    63129    RUNNING</span><br><span class="line">hello-runc    63241    RUNNING</span><br><span class="line"></span><br><span class="line">root@ubuntu-001:~# ctr tasks exec -t --exec-id 63129 hello-kata sh</span><br><span class="line">&#x2F; # uname -a</span><br><span class="line">Linux clr-84d1dc4d9ae34cad92be6e6629a4f67a 5.4.60-52.container #1 SMP Sat Jan 16 05:49:34 UTC 2021 x86_64 GNU&#x2F;Linux</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@ubuntu-001:~# ctr tasks exec -t --exec-id 63241 hello-runc sh</span><br><span class="line">&#x2F; # uname -a</span><br><span class="line">Linux ubuntu-001 5.4.0-65-generic #73~18.04.1-Ubuntu SMP Tue Jan 19 09:02:24 UTC 2021 x86_64 GNU&#x2F;Linux</span><br><span class="line"></span><br><span class="line">root@ubuntu-001:~# uname -a</span><br><span class="line">Linux ubuntu-001 5.4.0-65-generic #73~18.04.1-Ubuntu SMP Tue Jan 19 09:02:24 UTC 2021 x86_64 x86_64 x86_64 GNU&#x2F;Linux</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">停止容器</span><br><span class="line">root@ubuntu-001:~# ctr tasks list</span><br><span class="line">TASK          PID      STATUS    </span><br><span class="line">hello-kata    63129    RUNNING</span><br><span class="line">hello-runc    63241    RUNNING </span><br><span class="line">root@ubuntu-001:~# </span><br><span class="line">root@ubuntu-001:~# ctr tasks kill --signal 9 hello-kata</span><br><span class="line">root@ubuntu-001:~# ctr tasks kill --signal 9 hello-runc</span><br><span class="line">root@ubuntu-001:~# ctr tasks list</span><br><span class="line">TASK          PID      STATUS    </span><br><span class="line">hello-kata    63129    STOPPED</span><br><span class="line">hello-runc    63241    STOPPED</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">删除容器</span><br><span class="line">root@ubuntu-001:~# ctr container list</span><br><span class="line">CONTAINER     IMAGE                               RUNTIME                      </span><br><span class="line">hello-kata    docker.io&#x2F;library&#x2F;busybox:latest    io.containerd.run.kata.v2    </span><br><span class="line">hello-runc    docker.io&#x2F;library&#x2F;busybox:latest    io.containerd.runc.v2        </span><br><span class="line">root@ubuntu-001:~# ctr container rm hello-kata</span><br><span class="line">root@ubuntu-001:~# ctr container rm hello-runc</span><br><span class="line">root@ubuntu-001:~# ctr container list</span><br><span class="line">CONTAINER    IMAGE    RUNTIME    </span><br></pre></td></tr></table></figure>


    </div>

    <div>全文完。</div>
  </article>
  <div class="toc-container">
    
  <div id="toc" class="toc-article">
    <strong class="toc-title">目录</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E6%8F%90%E6%9D%A1%E4%BB%B6"><span class="toc-text">前提条件</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEcontainerd%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">配置containerd配置文件</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%87%8D%E5%90%AFcontainerd%E6%9C%8D%E5%8A%A1"><span class="toc-text">重启containerd服务</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEcri%E7%9A%84%E5%91%BD%E4%BB%A4%E8%A1%8C%EF%BC%88crictl%EF%BC%89%E9%85%8D%E7%BD%AE"><span class="toc-text">配置cri的命令行（crictl）配置</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8containerd%E8%BF%90%E8%A1%8C%E5%AE%B9%E5%99%A8"><span class="toc-text">使用containerd运行容器</span></a></li></ol>
  </div>


  </div>
</div>
<div class="copyright">
    <span>本作品采用</span>
    <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by/4.0/">知识共享署名 4.0 国际许可协议</a>
    <span>进行许可。 转载时请注明原文链接。</span>
</div>
<div class="share" style="width: 100%;">
  <img src="https://yushanjin.github.io/images/wechat.jpg" alt="Running Geek" style="margin: auto; display: block;"/>

  <div style="margin: auto; text-align: center; font-size: 0.8em; color: grey;">老铁们关注走一走，不迷路</div>
  
</div>

  
    <div class="post-nav">
      <div class="post-nav-item post-nav-next">
        
          <span>〈 </span>
          <a href="/2021/02/07/docker-with-kata-container/" rel="next" title="docker with kata-container">
          docker with kata-container
          </a>
        
      </div>
  
      <div class="post-nav-item post-nav-prev">
          
      </div>
    </div>
  


    </div>

    

  </div>
  <footer class="footer text-center">
    <div id="bottom-inner">
        <a class="bottom-item" href="https://yushanjin.github.io/">首页</a> |
        <a class="bottom-item" href="https://yushanjin.github.io/" target="_blank">主站</a> |
        <a class="bottom-item" href="https://github.com/yushanjin" target="_blank">GitHub</a> |
        <a class="bottom-item" href="https://hexo.io" target="_blank">Powered by hexo</a> |
        <a class="bottom-item" href="https://github.com/KevinOfNeu/hexo-theme-xoxo" target="_blank">Theme xoxo</a>
    </div>
</footer>
  

<script>
  (function(window, document, undefined) {

    var timer = null;

    function returnTop() {
      cancelAnimationFrame(timer);
      timer = requestAnimationFrame(function fn() {
        var oTop = document.body.scrollTop || document.documentElement.scrollTop;
        if (oTop > 0) {
          document.body.scrollTop = document.documentElement.scrollTop = oTop - 50;
          timer = requestAnimationFrame(fn);
        } else {
          cancelAnimationFrame(timer);
        }
      });
    }

    var hearts = [];
    window.requestAnimationFrame = (function() {
      return window.requestAnimationFrame ||
        window.webkitRequestAnimationFrame ||
        window.mozRequestAnimationFrame ||
        window.oRequestAnimationFrame ||
        window.msRequestAnimationFrame ||
        function(callback) {
          setTimeout(callback, 1000 / 60);
        }
    })();
    init();

    function init() {
      css(".heart{z-index:9999;width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: absolute;}.heart:after{top: -5px;}.heart:before{left: -5px;}");
      attachEvent();
      gameloop();
      addMenuEvent();
    }

    function gameloop() {
      for (var i = 0; i < hearts.length; i++) {
        if (hearts[i].alpha <= 0) {
          document.body.removeChild(hearts[i].el);
          hearts.splice(i, 1);
          continue;
        }
        hearts[i].y--;
        hearts[i].scale += 0.004;
        hearts[i].alpha -= 0.013;
        hearts[i].el.style.cssText = "left:" + hearts[i].x + "px;top:" + hearts[i].y + "px;opacity:" + hearts[i].alpha + ";transform:scale(" + hearts[i].scale + "," + hearts[i].scale + ") rotate(45deg);background:" + hearts[i].color;
      }
      requestAnimationFrame(gameloop);
    }

    /**
     * 给logo设置点击事件
     * 
     * - 回到顶部
     * - 出现爱心
     */
    function attachEvent() {
      var old = typeof window.onclick === "function" && window.onclick;
      var logo = document.getElementById("logo");
      if (logo) {
        logo.onclick = function(event) {
          returnTop();
          old && old();
          createHeart(event);
        }
      }
      
    }

    function createHeart(event) {
      var d = document.createElement("div");
      d.className = "heart";
      hearts.push({
        el: d,
        x: event.clientX - 5,
        y: event.clientY - 5,
        scale: 1,
        alpha: 1,
        color: randomColor()
      });
      document.body.appendChild(d);
    }

    function css(css) {
      var style = document.createElement("style");
      style.type = "text/css";
      try {
        style.appendChild(document.createTextNode(css));
      } catch (ex) {
        style.styleSheet.cssText = css;
      }
      document.getElementsByTagName('head')[0].appendChild(style);
    }

    function randomColor() {
      // return "rgb(" + (~~(Math.random() * 255)) + "," + (~~(Math.random() * 255)) + "," + (~~(Math.random() * 255)) + ")";
      return "#F44336";
    }

    function addMenuEvent() {
      var menu = document.getElementById('menu-main-post');
      if (menu) {
        var toc = document.getElementById('toc');
        if (toc) {
          menu.onclick = function() {
            if (toc) {
              if (toc.style.display == 'block') {
                toc.style.display = 'none';
              } else {
                toc.style.display = 'block';
              }
            }
          };
        } else {
          menu.style.display = 'none';
        }
      }
    }

  })(window, document);
</script>

  



</body>
</html>
