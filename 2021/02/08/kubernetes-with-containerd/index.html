
<!DOCTYPE html>
<html lang="zh-CN">


<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#202020"/>
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>
  
  
    <meta name="keywords" content="kubernetes,containerd," />
  

  
    <meta name="description" content="kubernetes with containerd" />
  
  
  <link rel="icon" type="image/x-icon" href="/images/logo.jpg">
  <title>kubernetes with containerd [ Yushanjin&#39;s Blog ]</title>
  
    <!-- stylesheets list from config.yml -->
    
      <link rel="stylesheet" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css">
    
      <link rel="stylesheet" href="/css/xoxo.css">
    
  
<meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="Yushanjin's Blog" type="application/atom+xml">
</head>


<body>
  <div class="nav-container">
    <nav class="home-menu pure-menu pure-menu-horizontal">
  <a class="pure-menu-heading" href="/">
    <img class="avatar" src="https://yushanjin.github.io/images/logo.jpg">
    <span class="title">Yushanjin&#39;s Blog</span>
  </a>

  <ul class="pure-menu-list clearfix">
      
          
            <li class="pure-menu-item"><a href="/" class="pure-menu-link">首页</a></li>
          
      
          
            <li class="pure-menu-item"><a href="/archives" class="pure-menu-link">归档</a></li>
          
      
          
            <li class="pure-menu-item"><a href="/tags" class="pure-menu-link">标签</a></li>
          
      
          
            <li class="pure-menu-item"><a href="/categories" class="pure-menu-link">分类</a></li>
          
      
          
            <li class="pure-menu-item"><a href="/search" class="pure-menu-link">搜索</a></li>
          
      
          
            <li class="pure-menu-item"><a href="/about" class="pure-menu-link">关于</a></li>
          
      
          
            <li class="pure-menu-item"><a href="/atom.xml" class="pure-menu-link">订阅</a></li>
          
      
  </ul>
   
</nav>

  </div>

  <div class="container" id="content-outer">
    <div class="inner" id="content-inner">
      <div class="post-container">
  <article class="post" id="post">
    <header class="post-header text-center">
      <h1 class="title">
        kubernetes with containerd
      </h1>
      <span>
        
        <time class="time" datetime="2021-02-08T06:01:17.000Z">
        2021-02-08
      </time>
        
      </span>
      <span class="slash">/</span>
      <span class="post-meta">
      <span class="post-tags">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/containerd/" rel="tag">containerd</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes/" rel="tag">kubernetes</a></li></ul>
      </span>
    </span>
      <span class="slash">/</span>
      <span class="read">
      <span id="busuanzi_value_page_pv"></span> 点击
    </span>
      <span class="slash">/</span>
      <span class="read">阅读耗时 29 分钟</span>
    </header>

    <div class="post-content">
      <p>参考：<a target="_blank" rel="noopener" href="https://www.hi-linux.com/posts/10148.html">https://www.hi-linux.com/posts/10148.html</a></p>
<h1 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h1><p>已安装kata container及containerd with CRI plugin</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-001:~# kata-runtime --version</span><br><span class="line">kata-runtime  : 1.13.0-alpha0</span><br><span class="line">   commit   : &lt;&lt;unknown&gt;&gt;</span><br><span class="line">   OCI specs: 1.0.1-dev</span><br><span class="line"></span><br><span class="line">root@ubuntu-001:~# containerd --version</span><br><span class="line">containerd containerd.io 1.4.3 269548fa27e0089a8b8278fc4fc781d7f65a939b</span><br><span class="line"></span><br><span class="line">root@ubuntu-001:~# ctr --version</span><br><span class="line">ctr containerd.io 1.4.3</span><br></pre></td></tr></table></figure>
<p>注意：</p>
<p>containerd在安装docker（新版本docker）已经作为docker依赖项安装了</p>
<p>ctr是containerd的命令行工具（containerd CLI）</p>
<p>cri is a native plugin of containerd 1.1 and above. It is built into containerd and enabled by default. You do not need to install cri if you have containerd 1.1 or above. Just remove the cri plugin from the list of disabled_plugins in the containerd configuration file (/etc/containerd/config.toml).</p>
<p><strong>目前的主要问题是，Kata 不支持 host 网络。而 Kubernetes 中，etcd、nodelocaldns、kube-apiserver、kube-scheduler、metrics-server、node-exporter、kube-proxy、calico、kube-controller-manager 等，也就是 Static Pod 和 Daemonset 都会使用 host 网络。所以在安装部署时，依然使用 runc 作为默认的运行时，而将 kata-runtime 作为可选的运行时给特定的负载使用。</strong></p>
<h1 id="基于kubeadm搭建kubernetes集群"><a href="#基于kubeadm搭建kubernetes集群" class="headerlink" title="基于kubeadm搭建kubernetes集群"></a>基于kubeadm搭建kubernetes集群</h1><h2 id="1、安装kubelet、kubeadm-和-kubectl"><a href="#1、安装kubelet、kubeadm-和-kubectl" class="headerlink" title="1、安装kubelet、kubeadm 和 kubectl"></a>1、安装kubelet、kubeadm 和 kubectl</h2><p><strong>配置kubernetes.repo的源，由于官方源国内无法访问，这里使用阿里云源</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;kubernetes&#x2F;apt&#x2F;doc&#x2F;apt-key.gpg | apt-key add - </span><br><span class="line">cat &lt;&lt;EOF &gt;&#x2F;etc&#x2F;apt&#x2F;sources.list.d&#x2F;kubernetes.list</span><br><span class="line">deb https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;kubernetes&#x2F;apt&#x2F; kubernetes-xenial main</span><br><span class="line">EOF  </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>在所有节点上安装指定版本 kubelet、kubeadm 和 kubectl</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">apt-get update</span><br><span class="line">apt-cache madison kubectl</span><br><span class="line">apt-cache madison kubeadm</span><br><span class="line">apt-cache madison kubelet</span><br><span class="line">apt-get install -y kubelet&#x3D;1.19.3-00 kubeadm&#x3D;1.19.3-00 kubectl&#x3D;1.19.3-00</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>启动kubelet服务</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable kubelet &amp;&amp; systemctl start kubelet </span><br></pre></td></tr></table></figure>

<h2 id="2、关闭swap分区"><a href="#2、关闭swap分区" class="headerlink" title="2、关闭swap分区"></a>2、关闭swap分区</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a</span><br></pre></td></tr></table></figure>

<h2 id="3、初始化master节点-–control-plane-endpoint指定vip，搭建HA集群，–cri-socket指定containerd为容器运行时，默认为docker"><a href="#3、初始化master节点-–control-plane-endpoint指定vip，搭建HA集群，–cri-socket指定containerd为容器运行时，默认为docker" class="headerlink" title="3、初始化master节点(–control-plane-endpoint指定vip，搭建HA集群，–cri-socket指定containerd为容器运行时，默认为docker)"></a>3、初始化master节点(–control-plane-endpoint指定vip，搭建HA集群，–cri-socket指定containerd为容器运行时，默认为docker)</h2><p>kubeadm init <strong>–control-plane-endpoint 10.0.105.121</strong> –image-repository registry.aliyuncs.com/google_containers <strong>–cri-socket /run/containerd/containerd.sock</strong> –kubernetes-version v1.19.3 –pod-network-cidr 10.244.0.0/16 –token-ttl 0 –ignore-preflight-errors Swap –upload-certs</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-001:~# kubeadm init --control-plane-endpoint 10.0.105.121 --image-repository registry.aliyuncs.com&#x2F;google_containers --cri-socket &#x2F;run&#x2F;containerd&#x2F;containerd.sock --kubernetes-version v1.19.3 --pod-network-cidr 10.244.0.0&#x2F;16 --token-ttl 0 --ignore-preflight-errors Swap --upload-certs</span><br><span class="line">W0208 10:57:44.075039   30107 configset.go:348] WARNING: kubeadm cannot validate component configs for API groups [kubelet.config.k8s.io kubeproxy.config.k8s.io]</span><br><span class="line">[init] Using Kubernetes version: v1.19.3</span><br><span class="line">[preflight] Running pre-flight checks</span><br><span class="line">[preflight] Pulling images required for setting up a Kubernetes cluster</span><br><span class="line">[preflight] This might take a minute or two, depending on the speed of your internet connection</span><br><span class="line">[preflight] You can also perform this action in beforehand using &#39;kubeadm config images pull&#39;</span><br><span class="line">[certs] Using certificateDir folder &quot;&#x2F;etc&#x2F;kubernetes&#x2F;pki&quot;</span><br><span class="line">[certs] Generating &quot;ca&quot; certificate and key</span><br><span class="line">[certs] Generating &quot;apiserver&quot; certificate and key</span><br><span class="line">[certs] apiserver serving cert is signed for DNS names [kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local ubuntu-001] and IPs [10.96.0.1 10.0.105.121]</span><br><span class="line">[certs] Generating &quot;apiserver-kubelet-client&quot; certificate and key</span><br><span class="line">[certs] Generating &quot;front-proxy-ca&quot; certificate and key</span><br><span class="line">[certs] Generating &quot;front-proxy-client&quot; certificate and key</span><br><span class="line">[certs] Generating &quot;etcd&#x2F;ca&quot; certificate and key</span><br><span class="line">[certs] Generating &quot;etcd&#x2F;server&quot; certificate and key</span><br><span class="line">[certs] etcd&#x2F;server serving cert is signed for DNS names [localhost ubuntu-001] and IPs [10.0.105.121 127.0.0.1 ::1]</span><br><span class="line">[certs] Generating &quot;etcd&#x2F;peer&quot; certificate and key</span><br><span class="line">[certs] etcd&#x2F;peer serving cert is signed for DNS names [localhost ubuntu-001] and IPs [10.0.105.121 127.0.0.1 ::1]</span><br><span class="line">[certs] Generating &quot;etcd&#x2F;healthcheck-client&quot; certificate and key</span><br><span class="line">[certs] Generating &quot;apiserver-etcd-client&quot; certificate and key</span><br><span class="line">[certs] Generating &quot;sa&quot; key and public key</span><br><span class="line">[kubeconfig] Using kubeconfig folder &quot;&#x2F;etc&#x2F;kubernetes&quot;</span><br><span class="line">[kubeconfig] Writing &quot;admin.conf&quot; kubeconfig file</span><br><span class="line">[kubeconfig] Writing &quot;kubelet.conf&quot; kubeconfig file</span><br><span class="line">[kubeconfig] Writing &quot;controller-manager.conf&quot; kubeconfig file</span><br><span class="line">[kubeconfig] Writing &quot;scheduler.conf&quot; kubeconfig file</span><br><span class="line">[kubelet-start] Writing kubelet environment file with flags to file &quot;&#x2F;var&#x2F;lib&#x2F;kubelet&#x2F;kubeadm-flags.env&quot;</span><br><span class="line">[kubelet-start] Writing kubelet configuration to file &quot;&#x2F;var&#x2F;lib&#x2F;kubelet&#x2F;config.yaml&quot;</span><br><span class="line">[kubelet-start] Starting the kubelet</span><br><span class="line">[control-plane] Using manifest folder &quot;&#x2F;etc&#x2F;kubernetes&#x2F;manifests&quot;</span><br><span class="line">[control-plane] Creating static Pod manifest for &quot;kube-apiserver&quot;</span><br><span class="line">[control-plane] Creating static Pod manifest for &quot;kube-controller-manager&quot;</span><br><span class="line">[control-plane] Creating static Pod manifest for &quot;kube-scheduler&quot;</span><br><span class="line">[etcd] Creating static Pod manifest for local etcd in &quot;&#x2F;etc&#x2F;kubernetes&#x2F;manifests&quot;</span><br><span class="line">[wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory &quot;&#x2F;etc&#x2F;kubernetes&#x2F;manifests&quot;. This can take up to 4m0s</span><br><span class="line">[apiclient] All control plane components are healthy after 13.501962 seconds</span><br><span class="line">[upload-config] Storing the configuration used in ConfigMap &quot;kubeadm-config&quot; in the &quot;kube-system&quot; Namespace</span><br><span class="line">[kubelet] Creating a ConfigMap &quot;kubelet-config-1.19&quot; in namespace kube-system with the configuration for the kubelets in the cluster</span><br><span class="line">[upload-certs] Storing the certificates in Secret &quot;kubeadm-certs&quot; in the &quot;kube-system&quot; Namespace</span><br><span class="line">[upload-certs] Using certificate key:</span><br><span class="line">4e30c9182268879cf56b505c9b4e173325d06ab7e1ef2ad8332ef448a9297333</span><br><span class="line">[mark-control-plane] Marking the node ubuntu-001 as control-plane by adding the label &quot;node-role.kubernetes.io&#x2F;master&#x3D;&#39;&#39;&quot;</span><br><span class="line">[mark-control-plane] Marking the node ubuntu-001 as control-plane by adding the taints [node-role.kubernetes.io&#x2F;master:NoSchedule]</span><br><span class="line">[bootstrap-token] Using token: nh9l3h.4ufk3uoiyedne5mv</span><br><span class="line">[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles</span><br><span class="line">[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to get nodes</span><br><span class="line">[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials</span><br><span class="line">[bootstrap-token] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token</span><br><span class="line">[bootstrap-token] configured RBAC rules to allow certificate rotation for all node client certificates in the cluster</span><br><span class="line">[bootstrap-token] Creating the &quot;cluster-info&quot; ConfigMap in the &quot;kube-public&quot; namespace</span><br><span class="line">[kubelet-finalize] Updating &quot;&#x2F;etc&#x2F;kubernetes&#x2F;kubelet.conf&quot; to point to a rotatable kubelet client certificate and key</span><br><span class="line">[addons] Applied essential addon: CoreDNS</span><br><span class="line">[addons] Applied essential addon: kube-proxy</span><br><span class="line"></span><br><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  mkdir -p $HOME&#x2F;.kube</span><br><span class="line">  sudo cp -i &#x2F;etc&#x2F;kubernetes&#x2F;admin.conf $HOME&#x2F;.kube&#x2F;config</span><br><span class="line">  sudo chown $(id -u):$(id -g) $HOME&#x2F;.kube&#x2F;config</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:</span><br><span class="line">  https:&#x2F;&#x2F;kubernetes.io&#x2F;docs&#x2F;concepts&#x2F;cluster-administration&#x2F;addons&#x2F;</span><br><span class="line"></span><br><span class="line">You can now join any number of the control-plane node running the following command on each as root:</span><br><span class="line"></span><br><span class="line">  kubeadm join 10.0.105.121:6443 --token nh9l3h.4ufk3uoiyedne5mv \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:0ab2bf0feb7ba1ee5ebdbdc5d81f542a952e708044db5f6f2124ae5b5fe8a7cd \</span><br><span class="line">    --control-plane --certificate-key 4e30c9182268879cf56b505c9b4e173325d06ab7e1ef2ad8332ef448a9297333</span><br><span class="line"></span><br><span class="line">Please note that the certificate-key gives access to cluster sensitive data, keep it secret!</span><br><span class="line">As a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use</span><br><span class="line">&quot;kubeadm init phase upload-certs --upload-certs&quot; to reload certs afterward.</span><br><span class="line"></span><br><span class="line">Then you can join any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm join 10.0.105.121:6443 --token nh9l3h.4ufk3uoiyedne5mv \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:0ab2bf0feb7ba1ee5ebdbdc5d81f542a952e708044db5f6f2124ae5b5fe8a7cd</span><br></pre></td></tr></table></figure>

<p>按照kubeadm init成功后打印提示，安装网络插件flannel，加入其它master节点及node节点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-001:~# kubectl get node -o wide</span><br><span class="line">NAME         STATUS   ROLES    AGE   VERSION   INTERNAL-IP    EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME</span><br><span class="line">ubuntu-001   Ready    master   53s   v1.19.3   10.0.105.121   &lt;none&gt;        Ubuntu 18.04.3 LTS   5.4.0-65-generic   containerd:&#x2F;&#x2F;1.4.3</span><br><span class="line"></span><br><span class="line">root@ubuntu-001:~# kubectl get pods --all-namespaces -o wide</span><br><span class="line">NAMESPACE     NAME                                 READY   STATUS    RESTARTS   AGE   IP             NODE         NOMINATED NODE   READINESS GATES</span><br><span class="line">kube-system   coredns-6d56c8448f-9fnlx             1&#x2F;1     Running   0          15m   10.244.0.2     ubuntu-001   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   coredns-6d56c8448f-vfvcg             1&#x2F;1     Running   0          15m   10.244.0.3     ubuntu-001   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   etcd-ubuntu-001                      1&#x2F;1     Running   0          16m   10.0.105.121   ubuntu-001   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-apiserver-ubuntu-001            1&#x2F;1     Running   0          16m   10.0.105.121   ubuntu-001   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-controller-manager-ubuntu-001   1&#x2F;1     Running   0          16m   10.0.105.121   ubuntu-001   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-flannel-ds-8j8cl                1&#x2F;1     Running   0          22s   10.0.105.121   ubuntu-001   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-proxy-cg2ln                     1&#x2F;1     Running   0          15m   10.0.105.121   ubuntu-001   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-scheduler-ubuntu-001            1&#x2F;1     Running   0          16m   10.0.105.121   ubuntu-001   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>可以看到容器运行时使用的是containerd://1.4.3</p>
<p>默认master节点不会调度pod，去掉此限制(可选做)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-001:~# kubectl taint node --all node-role.kubernetes.io&#x2F;master:NoSchedule-</span><br><span class="line">node&#x2F;ubuntu-001 untainted</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-001:~# crictl pods</span><br><span class="line">POD ID              CREATED             STATE               NAME                                 NAMESPACE           ATTEMPT</span><br><span class="line">9cc752c5fede8       22 seconds ago      Ready               coredns-6d56c8448f-vfvcg             kube-system         0</span><br><span class="line">980935e9ea8f2       24 seconds ago      Ready               coredns-6d56c8448f-9fnlx             kube-system         0</span><br><span class="line">a4ce86d80fa28       31 seconds ago      Ready               kube-flannel-ds-8j8cl                kube-system         0</span><br><span class="line">1aa88e7a6e40c       16 minutes ago      Ready               kube-proxy-cg2ln                     kube-system         0</span><br><span class="line">bd1f9e7022de5       16 minutes ago      Ready               kube-scheduler-ubuntu-001            kube-system         0</span><br><span class="line">2dd7e343fdaaa       16 minutes ago      Ready               etcd-ubuntu-001                      kube-system         0</span><br><span class="line">96f52cba3a131       16 minutes ago      Ready               kube-controller-manager-ubuntu-001   kube-system         0</span><br><span class="line">6ab9ae42f6ff3       16 minutes ago      Ready               kube-apiserver-ubuntu-001            kube-system         0</span><br><span class="line"></span><br><span class="line">root@ubuntu-001:~# docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</span><br><span class="line"></span><br><span class="line">root@ubuntu-001:~# crictl ps</span><br><span class="line">CONTAINER ID        IMAGE               CREATED              STATE               NAME                      ATTEMPT             POD ID</span><br><span class="line">0cd56ff487375       bfe3a36ebd252       About a minute ago   Running             coredns                   0                   9cc752c5fede8</span><br><span class="line">d48bacaa9c210       bfe3a36ebd252       About a minute ago   Running             coredns                   0                   980935e9ea8f2</span><br><span class="line">dc2be48b4143d       f03a23d55e578       About a minute ago   Running             kube-flannel              0                   a4ce86d80fa28</span><br><span class="line">4dd35f6ad4ce3       cdef7632a242b       16 minutes ago       Running             kube-proxy                0                   1aa88e7a6e40c</span><br><span class="line">dc1baf15016e0       aaefbfa906bd8       17 minutes ago       Running             kube-scheduler            0                   bd1f9e7022de5</span><br><span class="line">f37feb9c32ad3       0369cf4303ffd       17 minutes ago       Running             etcd                      0                   2dd7e343fdaaa</span><br><span class="line">08823e6edbb1c       9b60aca1d8180       17 minutes ago       Running             kube-controller-manager   0                   96f52cba3a131</span><br><span class="line">fc78e9051b6f0       a301be0cd44bb       17 minutes ago       Running             kube-apiserver            0                   6ab9ae42f6ff3</span><br><span class="line"></span><br><span class="line">root@ubuntu-001:~# ps -ef|grep containerd</span><br><span class="line">root      29906      1  0 10:57 ?        00:00:03 &#x2F;usr&#x2F;bin&#x2F;containerd</span><br><span class="line">root      29928      1  0 10:57 ?        00:00:00 &#x2F;usr&#x2F;bin&#x2F;dockerd -H fd:&#x2F;&#x2F; --containerd&#x3D;&#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">root      30559      1  0 10:57 ?        00:00:00 &#x2F;usr&#x2F;bin&#x2F;containerd-shim-runc-v2 -namespace k8s.io -id 6ab9ae42f6ff3505762ce6c7676dbd74a45b6f2902c6eb32e82d70cb1d853be7 -address &#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">root      30631      1  0 10:57 ?        00:00:00 &#x2F;usr&#x2F;bin&#x2F;containerd-shim-runc-v2 -namespace k8s.io -id 96f52cba3a13165938769b136f4f786d7d073dcb85d120c9a1d45da653101545 -address &#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">root      30707      1  0 10:57 ?        00:00:00 &#x2F;usr&#x2F;bin&#x2F;containerd-shim-runc-v2 -namespace k8s.io -id 2dd7e343fdaaa0b0d54e704a429134584c5f85a8ead0623c41e242d8c92e0e50 -address &#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">root      30913      1  0 10:57 ?        00:00:00 &#x2F;usr&#x2F;bin&#x2F;containerd-shim-runc-v2 -namespace k8s.io -id bd1f9e7022de5b8585afd4bfeabe6189eb21fd013643dff3c44dc71c5379dfa5 -address &#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">root      31322      1  1 10:58 ?        00:00:15 &#x2F;usr&#x2F;bin&#x2F;kubelet --bootstrap-kubeconfig&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;bootstrap-kubelet.conf --kubeconfig&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;kubelet.conf --config&#x3D;&#x2F;var&#x2F;lib&#x2F;kubelet&#x2F;config.yaml --container-runtime&#x3D;remote --container-runtime-endpoint&#x3D;&#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">root      31667      1  0 10:58 ?        00:00:00 &#x2F;usr&#x2F;bin&#x2F;containerd-shim-runc-v2 -namespace k8s.io -id 1aa88e7a6e40cea8cb3386841b9204e0ad17ba258efcd40e28bfbcdf2f4300be -address &#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">root      40524      1  0 11:13 ?        00:00:00 &#x2F;usr&#x2F;bin&#x2F;containerd-shim-runc-v2 -namespace k8s.io -id a4ce86d80fa28dd289186c104698b36fc112de9195121c0d52a1b50e68007471 -address &#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">root      40920      1  0 11:13 ?        00:00:00 &#x2F;usr&#x2F;bin&#x2F;containerd-shim-runc-v2 -namespace k8s.io -id 980935e9ea8f29b3e77d4128a13da7cead0b0db068b04ac26076fe8ac9d17694 -address &#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">root      41153      1  0 11:14 ?        00:00:00 &#x2F;usr&#x2F;bin&#x2F;containerd-shim-runc-v2 -namespace k8s.io -id 9cc752c5fede80ceb14c1e1f66ed87460e3c396b881b4d53d02b5f858cbe134e -address &#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line"></span><br><span class="line">可以看到底层的运行时还是runc，因为在我们的containerd配置文件里是这样配置的</span><br><span class="line"></span><br><span class="line">root@ubuntu-001:~# crictl images ls</span><br><span class="line">IMAGE                                                             TAG                 IMAGE ID            SIZE</span><br><span class="line">docker.io&#x2F;library&#x2F;nginx                                           latest              f6d0b4767a6c4       53.6MB</span><br><span class="line">quay.io&#x2F;coreos&#x2F;flannel                                            v0.13.1-rc1         f03a23d55e578       20.7MB</span><br><span class="line">registry.aliyuncs.com&#x2F;google_containers&#x2F;coredns                   1.7.0               bfe3a36ebd252       14MB</span><br><span class="line">registry.aliyuncs.com&#x2F;google_containers&#x2F;etcd                      3.4.13-0            0369cf4303ffd       86.7MB</span><br><span class="line">registry.aliyuncs.com&#x2F;google_containers&#x2F;kube-apiserver            v1.19.3             a301be0cd44bb       29.7MB</span><br><span class="line">registry.aliyuncs.com&#x2F;google_containers&#x2F;kube-controller-manager   v1.19.3             9b60aca1d8180       28MB</span><br><span class="line">registry.aliyuncs.com&#x2F;google_containers&#x2F;kube-proxy                v1.19.3             cdef7632a242b       49.3MB</span><br><span class="line">registry.aliyuncs.com&#x2F;google_containers&#x2F;kube-scheduler            v1.19.3             aaefbfa906bd8       13.8MB</span><br><span class="line">registry.aliyuncs.com&#x2F;google_containers&#x2F;pause                     3.2                 80d28bedfe5de       300kB</span><br></pre></td></tr></table></figure>

<h2 id="使用runc运行pod"><a href="#使用runc运行pod" class="headerlink" title="使用runc运行pod"></a>使用runc运行pod</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-001:~# cat pod.yaml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx</span><br><span class="line">    image: nginx</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 80</span><br><span class="line"></span><br><span class="line">root@ubuntu-001:~# kubectl apply -f pod.yaml</span><br><span class="line">pod&#x2F;nginx created</span><br><span class="line"></span><br><span class="line">root@ubuntu-001:~# kubectl get pods --all-namespaces</span><br><span class="line">NAMESPACE     NAME                                 READY   STATUS    RESTARTS   AGE</span><br><span class="line">default       nginx                                1&#x2F;1     Running   0          2m56s</span><br><span class="line">kube-system   coredns-6d56c8448f-9fnlx             1&#x2F;1     Running   0          33m</span><br><span class="line">kube-system   coredns-6d56c8448f-vfvcg             1&#x2F;1     Running   0          33m</span><br><span class="line">kube-system   etcd-ubuntu-001                      1&#x2F;1     Running   0          33m</span><br><span class="line">kube-system   kube-apiserver-ubuntu-001            1&#x2F;1     Running   0          33m</span><br><span class="line">kube-system   kube-controller-manager-ubuntu-001   1&#x2F;1     Running   0          33m</span><br><span class="line">kube-system   kube-flannel-ds-8j8cl                1&#x2F;1     Running   0          17m</span><br><span class="line">kube-system   kube-proxy-cg2ln                     1&#x2F;1     Running   0          33m</span><br><span class="line">kube-system   kube-scheduler-ubuntu-001            1&#x2F;1     Running   0          33m</span><br><span class="line"></span><br><span class="line">root@ubuntu-001:~# crictl pods</span><br><span class="line">POD ID              CREATED             STATE               NAME                                 NAMESPACE           ATTEMPT</span><br><span class="line">1a7b030c70a52       26 seconds ago      Ready               nginx                                default             0</span><br><span class="line">9cc752c5fede8       17 minutes ago      Ready               coredns-6d56c8448f-vfvcg             kube-system         0</span><br><span class="line">980935e9ea8f2       17 minutes ago      Ready               coredns-6d56c8448f-9fnlx             kube-system         0</span><br><span class="line">a4ce86d80fa28       17 minutes ago      Ready               kube-flannel-ds-8j8cl                kube-system         0</span><br><span class="line">1aa88e7a6e40c       33 minutes ago      Ready               kube-proxy-cg2ln                     kube-system         0</span><br><span class="line">bd1f9e7022de5       33 minutes ago      Ready               kube-scheduler-ubuntu-001            kube-system         0</span><br><span class="line">2dd7e343fdaaa       33 minutes ago      Ready               etcd-ubuntu-001                      kube-system         0</span><br><span class="line">96f52cba3a131       33 minutes ago      Ready               kube-controller-manager-ubuntu-001   kube-system         0</span><br><span class="line">6ab9ae42f6ff3       33 minutes ago      Ready               kube-apiserver-ubuntu-001            kube-system         0</span><br><span class="line"></span><br><span class="line">root@ubuntu-001:~# crictl ps</span><br><span class="line">CONTAINER ID        IMAGE               CREATED             STATE               NAME                      ATTEMPT             POD ID</span><br><span class="line">8aa19e57c4507       f6d0b4767a6c4       26 seconds ago      Running             nginx                     0                   1a7b030c70a52</span><br><span class="line">0cd56ff487375       bfe3a36ebd252       17 minutes ago      Running             coredns                   0                   9cc752c5fede8</span><br><span class="line">d48bacaa9c210       bfe3a36ebd252       17 minutes ago      Running             coredns                   0                   980935e9ea8f2</span><br><span class="line">dc2be48b4143d       f03a23d55e578       17 minutes ago      Running             kube-flannel              0                   a4ce86d80fa28</span><br><span class="line">4dd35f6ad4ce3       cdef7632a242b       33 minutes ago      Running             kube-proxy                0                   1aa88e7a6e40c</span><br><span class="line">dc1baf15016e0       aaefbfa906bd8       33 minutes ago      Running             kube-scheduler            0                   bd1f9e7022de5</span><br><span class="line">f37feb9c32ad3       0369cf4303ffd       33 minutes ago      Running             etcd                      0                   2dd7e343fdaaa</span><br><span class="line">08823e6edbb1c       9b60aca1d8180       33 minutes ago      Running             kube-controller-manager   0                   96f52cba3a131</span><br><span class="line">fc78e9051b6f0       a301be0cd44bb       33 minutes ago      Running             kube-apiserver            0                   6ab9ae42f6ff3</span><br><span class="line"></span><br><span class="line">root@ubuntu-001:~# ps -ef|grep containerd</span><br><span class="line">root      29906      1  0 10:57 ?        00:00:05 &#x2F;usr&#x2F;bin&#x2F;containerd</span><br><span class="line">root      29928      1  0 10:57 ?        00:00:00 &#x2F;usr&#x2F;bin&#x2F;dockerd -H fd:&#x2F;&#x2F; --containerd&#x3D;&#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">root      30559      1  0 10:57 ?        00:00:00 &#x2F;usr&#x2F;bin&#x2F;containerd-shim-runc-v2 -namespace k8s.io -id 6ab9ae42f6ff3505762ce6c7676dbd74a45b6f2902c6eb32e82d70cb1d853be7 -address &#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">root      30631      1  0 10:57 ?        00:00:00 &#x2F;usr&#x2F;bin&#x2F;containerd-shim-runc-v2 -namespace k8s.io -id 96f52cba3a13165938769b136f4f786d7d073dcb85d120c9a1d45da653101545 -address &#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">root      30707      1  0 10:57 ?        00:00:00 &#x2F;usr&#x2F;bin&#x2F;containerd-shim-runc-v2 -namespace k8s.io -id 2dd7e343fdaaa0b0d54e704a429134584c5f85a8ead0623c41e242d8c92e0e50 -address &#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">root      30913      1  0 10:57 ?        00:00:00 &#x2F;usr&#x2F;bin&#x2F;containerd-shim-runc-v2 -namespace k8s.io -id bd1f9e7022de5b8585afd4bfeabe6189eb21fd013643dff3c44dc71c5379dfa5 -address &#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">root      31322      1  1 10:58 ?        00:00:26 &#x2F;usr&#x2F;bin&#x2F;kubelet --bootstrap-kubeconfig&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;bootstrap-kubelet.conf --kubeconfig&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;kubelet.conf --config&#x3D;&#x2F;var&#x2F;lib&#x2F;kubelet&#x2F;config.yaml --container-runtime&#x3D;remote --container-runtime-endpoint&#x3D;&#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">root      31667      1  0 10:58 ?        00:00:00 &#x2F;usr&#x2F;bin&#x2F;containerd-shim-runc-v2 -namespace k8s.io -id 1aa88e7a6e40cea8cb3386841b9204e0ad17ba258efcd40e28bfbcdf2f4300be -address &#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">root      40524      1  0 11:13 ?        00:00:00 &#x2F;usr&#x2F;bin&#x2F;containerd-shim-runc-v2 -namespace k8s.io -id a4ce86d80fa28dd289186c104698b36fc112de9195121c0d52a1b50e68007471 -address &#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">root      40920      1  0 11:13 ?        00:00:00 &#x2F;usr&#x2F;bin&#x2F;containerd-shim-runc-v2 -namespace k8s.io -id 980935e9ea8f29b3e77d4128a13da7cead0b0db068b04ac26076fe8ac9d17694 -address &#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">root      41153      1  0 11:14 ?        00:00:00 &#x2F;usr&#x2F;bin&#x2F;containerd-shim-runc-v2 -namespace k8s.io -id 9cc752c5fede80ceb14c1e1f66ed87460e3c396b881b4d53d02b5f858cbe134e -address &#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">root      46631      1  0 11:31 ?        00:00:00 &#x2F;usr&#x2F;bin&#x2F;containerd-shim-runc-v2 -namespace k8s.io -id 1a7b030c70a524c2ce71b07b63119c11a84738818d6986d58521a9fd7cde9c69 -address &#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line"></span><br><span class="line">root@ubuntu-001:~# ps -ef|grep 46631</span><br><span class="line">root      46631      1  0 11:31 ?        00:00:00 &#x2F;usr&#x2F;bin&#x2F;containerd-shim-runc-v2 -namespace k8s.io -id 1a7b030c70a524c2ce71b07b63119c11a84738818d6986d58521a9fd7cde9c69 -address &#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">root      46660  46631  0 11:31 ?        00:00:00 &#x2F;pause</span><br><span class="line">root      46737  46631  0 11:31 ?        00:00:00 nginx: master process nginx -g daemon off;</span><br><span class="line">root      47687  58536  0 11:34 pts&#x2F;2    00:00:00 grep --color&#x3D;auto 46631</span><br><span class="line"></span><br><span class="line">pause容器及pod 容器以containerd-shim子进程形式存在</span><br><span class="line"></span><br><span class="line">root@ubuntu-001:~# ps -ef|grep 40920</span><br><span class="line">root      40920      1  0 11:13 ?        00:00:00 &#x2F;usr&#x2F;bin&#x2F;containerd-shim-runc-v2 -namespace k8s.io -id 980935e9ea8f29b3e77d4128a13da7cead0b0db068b04ac26076fe8ac9d17694 -address &#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">root      40960  40920  0 11:13 ?        00:00:00 &#x2F;pause</span><br><span class="line">root      41042  40920  0 11:13 ?        00:00:01 &#x2F;coredns -conf &#x2F;etc&#x2F;coredns&#x2F;Corefile</span><br><span class="line">root      47867  58536  0 11:34 pts&#x2F;2    00:00:00 grep --color&#x3D;auto 40920</span><br></pre></td></tr></table></figure>

<h2 id="使用kata-container运行pod"><a href="#使用kata-container运行pod" class="headerlink" title="使用kata container运行pod"></a>使用kata container运行pod</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-001:~# cat kata-runtime.yaml </span><br><span class="line">kind: RuntimeClass</span><br><span class="line">apiVersion: node.k8s.io&#x2F;v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: kata-containers</span><br><span class="line">handler: kata</span><br><span class="line"></span><br><span class="line">root@ubuntu-001:~# cat kata-pod.yaml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: kata-nginx</span><br><span class="line">spec:</span><br><span class="line">  runtimeClassName: kata-containers</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx</span><br><span class="line">    image: nginx</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 80</span><br><span class="line"></span><br><span class="line">root@ubuntu-001:~# kubectl apply -f kata-runtime.yaml </span><br><span class="line">runtimeclass.node.k8s.io&#x2F;kata-containers created</span><br><span class="line"></span><br><span class="line">root@ubuntu-001:~# kubectl apply -f kata-pod.yaml </span><br><span class="line">pod&#x2F;kata-nginx created</span><br><span class="line"></span><br><span class="line">root@ubuntu-001:~# kubectl get pods -o wide</span><br><span class="line">NAME         READY   STATUS    RESTARTS   AGE     IP           NODE         NOMINATED NODE   READINESS GATES</span><br><span class="line">kata-nginx   1&#x2F;1     Running   0          28s     10.244.0.5   ubuntu-001   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx        1&#x2F;1     Running   0          4h12m   10.244.0.4   ubuntu-001   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">root@ubuntu-001:~# crictl pods</span><br><span class="line">POD ID              CREATED             STATE               NAME                                 NAMESPACE           ATTEMPT</span><br><span class="line">f7f69925f3bdf       43 seconds ago      Ready               kata-nginx                           default             0</span><br><span class="line">1a7b030c70a52       4 hours ago         Ready               nginx                                default             0</span><br><span class="line">9cc752c5fede8       4 hours ago         Ready               coredns-6d56c8448f-vfvcg             kube-system         0</span><br><span class="line">980935e9ea8f2       4 hours ago         Ready               coredns-6d56c8448f-9fnlx             kube-system         0</span><br><span class="line">a4ce86d80fa28       4 hours ago         Ready               kube-flannel-ds-8j8cl                kube-system         0</span><br><span class="line">1aa88e7a6e40c       5 hours ago         Ready               kube-proxy-cg2ln                     kube-system         0</span><br><span class="line">bd1f9e7022de5       5 hours ago         Ready               kube-scheduler-ubuntu-001            kube-system         0</span><br><span class="line">2dd7e343fdaaa       5 hours ago         Ready               etcd-ubuntu-001                      kube-system         0</span><br><span class="line">96f52cba3a131       5 hours ago         Ready               kube-controller-manager-ubuntu-001   kube-system         0</span><br><span class="line">6ab9ae42f6ff3       5 hours ago         Ready               kube-apiserver-ubuntu-001            kube-system         0</span><br><span class="line"></span><br><span class="line">root@ubuntu-001:~# crictl ps</span><br><span class="line">CONTAINER ID        IMAGE               CREATED             STATE               NAME                      ATTEMPT             POD ID</span><br><span class="line">4487c2621c1b4       f6d0b4767a6c4       41 seconds ago      Running             nginx                     0                   f7f69925f3bdf</span><br><span class="line">8aa19e57c4507       f6d0b4767a6c4       4 hours ago         Running             nginx                     0                   1a7b030c70a52</span><br><span class="line">0cd56ff487375       bfe3a36ebd252       4 hours ago         Running             coredns                   0                   9cc752c5fede8</span><br><span class="line">d48bacaa9c210       bfe3a36ebd252       4 hours ago         Running             coredns                   0                   980935e9ea8f2</span><br><span class="line">dc2be48b4143d       f03a23d55e578       4 hours ago         Running             kube-flannel              0                   a4ce86d80fa28</span><br><span class="line">4dd35f6ad4ce3       cdef7632a242b       5 hours ago         Running             kube-proxy                0                   1aa88e7a6e40c</span><br><span class="line">dc1baf15016e0       aaefbfa906bd8       5 hours ago         Running             kube-scheduler            0                   bd1f9e7022de5</span><br><span class="line">f37feb9c32ad3       0369cf4303ffd       5 hours ago         Running             etcd                      0                   2dd7e343fdaaa</span><br><span class="line">08823e6edbb1c       9b60aca1d8180       5 hours ago         Running             kube-controller-manager   0                   96f52cba3a131</span><br><span class="line">fc78e9051b6f0       a301be0cd44bb       5 hours ago         Running             kube-apiserver            0                   6ab9ae42f6ff3</span><br><span class="line"></span><br><span class="line">root@ubuntu-001:~# ps -ef|grep containerd</span><br><span class="line">root      29906      1  0 12:21 ?        00:00:29 &#x2F;usr&#x2F;bin&#x2F;containerd</span><br><span class="line">root      29928      1  0 12:21 ?        00:00:03 &#x2F;usr&#x2F;bin&#x2F;dockerd -H fd:&#x2F;&#x2F; --containerd&#x3D;&#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">root      30559      1  0 12:21 ?        00:00:01 &#x2F;usr&#x2F;bin&#x2F;containerd-shim-runc-v2 -namespace k8s.io -id 6ab9ae42f6ff3505762ce6c7676dbd74a45b6f2902c6eb32e82d70cb1d853be7 -address &#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">root      30631      1  0 12:21 ?        00:00:01 &#x2F;usr&#x2F;bin&#x2F;containerd-shim-runc-v2 -namespace k8s.io -id 96f52cba3a13165938769b136f4f786d7d073dcb85d120c9a1d45da653101545 -address &#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">root      30707      1  0 12:21 ?        00:00:01 &#x2F;usr&#x2F;bin&#x2F;containerd-shim-runc-v2 -namespace k8s.io -id 2dd7e343fdaaa0b0d54e704a429134584c5f85a8ead0623c41e242d8c92e0e50 -address &#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">root      30913      1  0 12:21 ?        00:00:01 &#x2F;usr&#x2F;bin&#x2F;containerd-shim-runc-v2 -namespace k8s.io -id bd1f9e7022de5b8585afd4bfeabe6189eb21fd013643dff3c44dc71c5379dfa5 -address &#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">root      31322      1  1 12:22 ?        00:02:30 &#x2F;usr&#x2F;bin&#x2F;kubelet --bootstrap-kubeconfig&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;bootstrap-kubelet.conf --kubeconfig&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;kubelet.conf --config&#x3D;&#x2F;var&#x2F;lib&#x2F;kubelet&#x2F;config.yaml --container-runtime&#x3D;remote --container-runtime-endpoint&#x3D;&#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">root      31667      1  0 12:22 ?        00:00:01 &#x2F;usr&#x2F;bin&#x2F;containerd-shim-runc-v2 -namespace k8s.io -id 1aa88e7a6e40cea8cb3386841b9204e0ad17ba258efcd40e28bfbcdf2f4300be -address &#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">root      40524      1  0 12:37 ?        00:00:01 &#x2F;usr&#x2F;bin&#x2F;containerd-shim-runc-v2 -namespace k8s.io -id a4ce86d80fa28dd289186c104698b36fc112de9195121c0d52a1b50e68007471 -address &#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">root      40920      1  0 12:38 ?        00:00:01 &#x2F;usr&#x2F;bin&#x2F;containerd-shim-runc-v2 -namespace k8s.io -id 980935e9ea8f29b3e77d4128a13da7cead0b0db068b04ac26076fe8ac9d17694 -address &#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">root      41153      1  0 12:38 ?        00:00:01 &#x2F;usr&#x2F;bin&#x2F;containerd-shim-runc-v2 -namespace k8s.io -id 9cc752c5fede80ceb14c1e1f66ed87460e3c396b881b4d53d02b5f858cbe134e -address &#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">root      46631      1  0 12:55 ?        00:00:01 &#x2F;usr&#x2F;bin&#x2F;containerd-shim-runc-v2 -namespace k8s.io -id 1a7b030c70a524c2ce71b07b63119c11a84738818d6986d58521a9fd7cde9c69 -address &#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">root      96541      1  0 15:40 ?        00:00:00 &#x2F;usr&#x2F;bin&#x2F;containerd-shim-kata-v2 -namespace k8s.io -address &#x2F;run&#x2F;containerd&#x2F;containerd.sock -publish-binary &#x2F;usr&#x2F;bin&#x2F;containerd -id f7f69925f3bdfccc823f0672d7d554e4d2b7f3f7d1bf15c7db8802c03a162cff</span><br><span class="line">root      97121  58536  0 15:42 pts&#x2F;2    00:00:00 grep --color&#x3D;auto containerd</span><br><span class="line"></span><br><span class="line">root@ubuntu-001:~# ps -ef|grep 96541</span><br><span class="line">root      96541      1  0 15:40 ?        00:00:00 &#x2F;usr&#x2F;bin&#x2F;containerd-shim-kata-v2 -namespace k8s.io -address &#x2F;run&#x2F;containerd&#x2F;containerd.sock -publish-binary &#x2F;usr&#x2F;bin&#x2F;containerd -id f7f69925f3bdfccc823f0672d7d554e4d2b7f3f7d1bf15c7db8802c03a162cff</span><br><span class="line">root      97226  58536  0 15:42 pts&#x2F;2    00:00:00 grep --color&#x3D;auto 96541</span><br><span class="line"></span><br><span class="line">运行的是轻量的虚拟机，所以不存在pause进程</span><br><span class="line"></span><br><span class="line">root@ubuntu-001:~# ps -ef|grep 46631</span><br><span class="line">root      46631      1  0 12:55 ?        00:00:01 &#x2F;usr&#x2F;bin&#x2F;containerd-shim-runc-v2 -namespace k8s.io -id 1a7b030c70a524c2ce71b07b63119c11a84738818d6986d58521a9fd7cde9c69 -address &#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">root      46660  46631  0 12:55 ?        00:00:00 &#x2F;pause</span><br><span class="line">root      46737  46631  0 12:55 ?        00:00:00 nginx: master process nginx -g daemon off;</span><br><span class="line">root      97379  58536  0 15:43 pts&#x2F;2    00:00:00 grep --color&#x3D;auto 46631</span><br><span class="line"></span><br><span class="line">root@ubuntu-001:~# kata-runtime list</span><br><span class="line">ID                                                                 PID         STATUS      BUNDLE                                                                                                                  CREATED                          OWNER</span><br><span class="line">f7f69925f3bdfccc823f0672d7d554e4d2b7f3f7d1bf15c7db8802c03a162cff   -1          running     &#x2F;run&#x2F;containerd&#x2F;io.containerd.runtime.v2.task&#x2F;k8s.io&#x2F;f7f69925f3bdfccc823f0672d7d554e4d2b7f3f7d1bf15c7db8802c03a162cff   2021-02-08T07:40:46.667379896Z   #0</span><br><span class="line">4487c2621c1b4b2fe6214ea8d3916f1ce3fd0c691024ac947474603af7a51ea3   -1          running     &#x2F;run&#x2F;containerd&#x2F;io.containerd.runtime.v2.task&#x2F;k8s.io&#x2F;4487c2621c1b4b2fe6214ea8d3916f1ce3fd0c691024ac947474603af7a51ea3   2021-02-08T07:40:52.142467623Z   #0</span><br><span class="line"></span><br><span class="line">ID分别为kata-nginx的pod id及容器 id</span><br></pre></td></tr></table></figure>
    </div>

    <div>全文完。</div>
  </article>
  <div class="toc-container">
    
  <div id="toc" class="toc-article">
    <strong class="toc-title">目录</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E6%8F%90%E6%9D%A1%E4%BB%B6"><span class="toc-text">前提条件</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8Ekubeadm%E6%90%AD%E5%BB%BAkubernetes%E9%9B%86%E7%BE%A4"><span class="toc-text">基于kubeadm搭建kubernetes集群</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E5%AE%89%E8%A3%85kubelet%E3%80%81kubeadm-%E5%92%8C-kubectl"><span class="toc-text">1、安装kubelet、kubeadm 和 kubectl</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E5%85%B3%E9%97%ADswap%E5%88%86%E5%8C%BA"><span class="toc-text">2、关闭swap分区</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E5%88%9D%E5%A7%8B%E5%8C%96master%E8%8A%82%E7%82%B9-%E2%80%93control-plane-endpoint%E6%8C%87%E5%AE%9Avip%EF%BC%8C%E6%90%AD%E5%BB%BAHA%E9%9B%86%E7%BE%A4%EF%BC%8C%E2%80%93cri-socket%E6%8C%87%E5%AE%9Acontainerd%E4%B8%BA%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C%E6%97%B6%EF%BC%8C%E9%BB%98%E8%AE%A4%E4%B8%BAdocker"><span class="toc-text">3、初始化master节点(–control-plane-endpoint指定vip，搭建HA集群，–cri-socket指定containerd为容器运行时，默认为docker)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8runc%E8%BF%90%E8%A1%8Cpod"><span class="toc-text">使用runc运行pod</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8kata-container%E8%BF%90%E8%A1%8Cpod"><span class="toc-text">使用kata container运行pod</span></a></li></ol></li></ol>
  </div>


  </div>
</div>
<div class="copyright">
    <span>本作品采用</span>
    <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by/4.0/">知识共享署名 4.0 国际许可协议</a>
    <span>进行许可。 转载时请注明原文链接。</span>
</div>
<div class="share" style="width: 100%;">
  <img src="https://yushanjin.github.io/images/wechat.jpg" alt="Running Geek" style="margin: auto; display: block;"/>

  <div style="margin: auto; text-align: center; font-size: 0.8em; color: grey;">老铁们关注走一走，不迷路</div>
  
</div>

  
    <div class="post-nav">
      <div class="post-nav-item post-nav-next">
        
          <span>〈 </span>
          <a href="/2021/02/07/containerd-with-kata-container/" rel="next" title="containerd with kata-container">
          containerd with kata-container
          </a>
        
      </div>
  
      <div class="post-nav-item post-nav-prev">
          
      </div>
    </div>
  


    </div>

    

  </div>
  <footer class="footer text-center">
    <div id="bottom-inner">
        <a class="bottom-item" href="https://yushanjin.github.io/">首页</a> |
        <a class="bottom-item" href="https://yushanjin.github.io/" target="_blank">主站</a> |
        <a class="bottom-item" href="https://github.com/yushanjin" target="_blank">GitHub</a> |
        <a class="bottom-item" href="https://hexo.io" target="_blank">Powered by hexo</a> |
        <a class="bottom-item" href="https://github.com/KevinOfNeu/hexo-theme-xoxo" target="_blank">Theme xoxo</a>
    </div>
</footer>
  

<script>
  (function(window, document, undefined) {

    var timer = null;

    function returnTop() {
      cancelAnimationFrame(timer);
      timer = requestAnimationFrame(function fn() {
        var oTop = document.body.scrollTop || document.documentElement.scrollTop;
        if (oTop > 0) {
          document.body.scrollTop = document.documentElement.scrollTop = oTop - 50;
          timer = requestAnimationFrame(fn);
        } else {
          cancelAnimationFrame(timer);
        }
      });
    }

    var hearts = [];
    window.requestAnimationFrame = (function() {
      return window.requestAnimationFrame ||
        window.webkitRequestAnimationFrame ||
        window.mozRequestAnimationFrame ||
        window.oRequestAnimationFrame ||
        window.msRequestAnimationFrame ||
        function(callback) {
          setTimeout(callback, 1000 / 60);
        }
    })();
    init();

    function init() {
      css(".heart{z-index:9999;width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: absolute;}.heart:after{top: -5px;}.heart:before{left: -5px;}");
      attachEvent();
      gameloop();
      addMenuEvent();
    }

    function gameloop() {
      for (var i = 0; i < hearts.length; i++) {
        if (hearts[i].alpha <= 0) {
          document.body.removeChild(hearts[i].el);
          hearts.splice(i, 1);
          continue;
        }
        hearts[i].y--;
        hearts[i].scale += 0.004;
        hearts[i].alpha -= 0.013;
        hearts[i].el.style.cssText = "left:" + hearts[i].x + "px;top:" + hearts[i].y + "px;opacity:" + hearts[i].alpha + ";transform:scale(" + hearts[i].scale + "," + hearts[i].scale + ") rotate(45deg);background:" + hearts[i].color;
      }
      requestAnimationFrame(gameloop);
    }

    /**
     * 给logo设置点击事件
     * 
     * - 回到顶部
     * - 出现爱心
     */
    function attachEvent() {
      var old = typeof window.onclick === "function" && window.onclick;
      var logo = document.getElementById("logo");
      if (logo) {
        logo.onclick = function(event) {
          returnTop();
          old && old();
          createHeart(event);
        }
      }
      
    }

    function createHeart(event) {
      var d = document.createElement("div");
      d.className = "heart";
      hearts.push({
        el: d,
        x: event.clientX - 5,
        y: event.clientY - 5,
        scale: 1,
        alpha: 1,
        color: randomColor()
      });
      document.body.appendChild(d);
    }

    function css(css) {
      var style = document.createElement("style");
      style.type = "text/css";
      try {
        style.appendChild(document.createTextNode(css));
      } catch (ex) {
        style.styleSheet.cssText = css;
      }
      document.getElementsByTagName('head')[0].appendChild(style);
    }

    function randomColor() {
      // return "rgb(" + (~~(Math.random() * 255)) + "," + (~~(Math.random() * 255)) + "," + (~~(Math.random() * 255)) + ")";
      return "#F44336";
    }

    function addMenuEvent() {
      var menu = document.getElementById('menu-main-post');
      if (menu) {
        var toc = document.getElementById('toc');
        if (toc) {
          menu.onclick = function() {
            if (toc) {
              if (toc.style.display == 'block') {
                toc.style.display = 'none';
              } else {
                toc.style.display = 'block';
              }
            }
          };
        } else {
          menu.style.display = 'none';
        }
      }
    }

  })(window, document);
</script>

  



</body>
</html>
